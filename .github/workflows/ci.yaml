name: CI

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install system dependencies (for FAISS)
        run: sudo apt-get update && sudo apt-get install -y libopenblas-dev

      - name: Install core dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest pytest-asyncio

      - name: Install optional dependencies (for full adapter coverage)
        run: |
          pip install openai anthropic replicate httpx tenacity tiktoken
          pip install faiss-cpu  # CPU-only FAISS for testing persistent memory

      # Opsiyonel: Yalnızca testlerde kullanılan bağımlılıklar
      - name: Install test-only deps
        run: |
          pip install requests  # for http_fetch tool

      # Ortam değişkenleri: Testlerde gerçek API çağrıları yapılmayacaksa gerekmez,
      # ama bazı entegrasyon testleri için gerekebilir.
      - name: Set up secrets (if needed for live tests)
        if: false  # varsayılan olarak live API testi YAPILMAZ
        run: |
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $GITHUB_ENV
          echo "ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}" >> $GITHUB_ENV
          echo "REPLICATE_API_TOKEN=${{ secrets.REPLICATE_API_TOKEN }}" >> $GITHUB_ENV
          echo "HUGGINGFACEHUB_API_TOKEN=${{ secrets.HUGGINGFACEHUB_API_TOKEN }}" >> $GITHUB_ENV

      - name: Show installed packages
        run: pip list

      - name: Run unit tests (mocked, no live API calls)
        run: pytest -v --tb=short -m "not live"


        
